"""Add datasource name to construct perms

Revision ID: a2e7ece571a9
Revises: 2fcdcb35e487
Create Date: 2017-04-25 10:53:00.445273

"""

# revision identifiers, used by Alembic.
revision = 'a2e7ece571a9'
down_revision = '2fcdcb35e487'

from alembic import op
import sqlalchemy as sa
from superset import db
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy import (
    Column, Integer, String, ForeignKey)
from sqlalchemy.orm import backref, relationship


Base = declarative_base()


class SqlaTable(Base):
    """Declarative class to do query in upgrade"""
    __tablename__ = 'tables'
    id = Column(Integer, primary_key=True)
    database_id = Column(Integer, ForeignKey('dbs.id'), nullable=False)
    database_name = Column(String(250))
    database = relationship(
        'Database',
        backref=backref('tables', cascade='all, delete-orphan'),
        foreign_keys=[database_id])


class Database(Base):

    """An ORM object that stores Database related information"""

    __tablename__ = 'dbs'
    type = "table"
    id = Column(Integer, primary_key=True)
    database_name = Column(String(250), unique=True)


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('tables', sa.Column('database_name', sa.String(length=250), nullable=True))
    # ### end Alembic commands ###
    bind = op.get_bind()
    session = db.Session(bind=bind)

    tables = session.query(SqlaTable).all()
    for table in tables:
        table.database_name = table.database.database_name
        session.commit()
    session.close()

def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('tables') as batch_op:
        batch_op.drop_column('database_name')
    # ### end Alembic commands ###
